rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {
    
        // Helper function to check if the caller is an employer
        function isEmployer() {
            return request.auth != null && 
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'employer';
        }

        // Users Collection
        match /users/{userId} {
            // Users can read and create their own document
            allow read, create: if request.auth != null && request.auth.uid == userId;
            // Employers and the user themselves can update their document (except role for non-admins)
            allow update: if request.auth != null && (request.auth.uid == userId || isEmployer());
            // Only employers can delete
            allow delete: if isEmployer(); 
        }

        // Employees Collection
        match /employees/{docId} {
            allow read: if request.auth != null; 
            allow write: if isEmployer();       
        }

        // Leaves Collection
        match /leaves/{leaveId} {
            allow read: if request.auth != null && (isEmployer() || resource.data.empEmail == request.auth.token.email);
            allow create: if request.auth != null;
            allow update, delete: if isEmployer();
        }

        // Payroll Collection
        match /payroll/{payrollId} {
            allow read: if request.auth != null && (isEmployer() || resource.data.empEmail == request.auth.token.email);
            allow write: if isEmployer();
        }

        // Attendance Collection
        match /attendance/{attendanceId} {
            allow read: if request.auth != null;
            allow create: if request.auth != null && request.resource.data.empEmail == request.auth.token.email;
            allow update, delete: if isEmployer();
        }

        // Tasks Collection
        match /tasks/{taskId} {
            allow read: if request.auth != null;
            allow create: if isEmployer();
            allow update: if isEmployer() || (request.auth != null && resource.data.assigneeEmail == request.auth.token.email && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']));
            allow delete: if isEmployer();
        }

        // Documents Collection
        match /documents/{docId} {
            allow read, write: if request.auth != null;
        }

        // Notifications Collection
        match /notifications/{notifId} {
            allow read, write: if request.auth != null;
        }

        // Teams Collection
        match /teams/{teamId} {
            allow read, write: if request.auth != null;
        }

        // Chat Messages Collection
        match /chat_messages/{messageId} {
            allow read, write: if request.auth != null;
        }
    }
}
